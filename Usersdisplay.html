<!doctype html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Happy OWL App</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.theme.default.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>

    <style>
        body {
            font-family: 'Kanit', sans-serif;
            /* --- ‡πÉ‡∏™‡πà‡∏£‡∏π‡∏õ Background ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ --- */
            background: url('Gemini_Generated_Image_l9iv8ol9iv8ol9iv.png') no-repeat center center fixed;
            background-size: cover; /* ‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ */
            
            color: #1c1c1e;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 40px;
        }

        /* App Bar (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏∂‡∏ö‡πÅ‡∏™‡∏á‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏£‡∏π‡∏õ) */
        .app-bar {
            background: rgba(255, 255, 255, 0.85); /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ç‡∏≤‡∏ß‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÅ‡∏™‡∏á */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.3);
            position: fixed; top: 0; left: 0; right: 0; z-index: 50;
            height: 60px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        .app-title { font-size: 1.1rem; font-weight: 600; color: #000; }

        /* Content Area */
        .content-area { padding-top: 80px; }

        /* Form Card */
        .app-card {
            background: rgba(255, 255, 255, 0.95); /* ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ç‡∏≤‡∏ß‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÅ‡∏™‡∏á‡∏ô‡∏¥‡∏î‡πÜ */
            border-radius: 16px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15); /* Glassmorphism Shadow */
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        /* Inputs */
        .app-input {
            background: #F2F2F7;
            border: none;
            border-radius: 10px;
            padding: 14px;
            font-size: 1rem;
            width: 100%;
            transition: 0.2s;
            font-family: 'Kanit', sans-serif;
            margin-bottom: 12px;
        }
        .app-input:focus {
            background: #e5e5ea;
            outline: none;
        }

        /* Labels */
        .input-label {
            font-size: 0.9rem; font-weight: 500; color: #444; margin-bottom: 6px; display: block;
        }

        /* Button */
        .app-btn {
            background: #007AFF;
            color: white;
            font-weight: 600;
            border-radius: 12px;
            padding: 14px;
            width: 100%;
            border: none;
            font-size: 1rem;
            box-shadow: 0 4px 10px rgba(0,122,255,0.3);
            transition: transform 0.1s;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .app-btn:active { transform: scale(0.97); }
        .app-btn:disabled { background: #B0B0B6; box-shadow: none; }

        /* Carousel Items */
        .owl-carousel .item {
            background: #fff;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin: 10px 5px;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .user-img { width: 100%; height: 220px; object-fit: cover; }
        .user-info { padding: 16px; }
        .user-name { font-weight: 600; font-size: 1.1rem; color: #000; margin-bottom: 4px; }
        .user-msg { font-size: 0.95rem; color: #666; line-height: 1.5; }

        /* Navigation Buttons */
        .owl-nav { margin-top: 0 !important; }
        .owl-prev, .owl-next {
            position: absolute; top: 40%; transform: translateY(-50%);
            width: 40px; height: 40px; background: rgba(255,255,255,0.9) !important;
            border-radius: 50% !important; box-shadow: 0 4px 10px rgba(0,0,0,0.2) !important;
            display: flex !important; justify-content: center; align-items: center;
            color: #007AFF !important; font-size: 24px !important;
            transition: 0.2s;
        }
        .owl-prev { left: -10px; }
        .owl-next { right: -10px; }
        .owl-prev span, .owl-next span { font-size: 30px; line-height: 0; padding-bottom: 4px; }

        /* Badges */
        .badge {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; margin-top: 8px;
        }
        .badge-limited { background: #FFF4E5; color: #FF9500; }
        .badge-normal { background: #F2F2F7; color: #8E8E93; }

        /* Upload Area */
        .upload-area {
            border: 2px dashed #C7C7CC; border-radius: 10px; padding: 15px;
            text-align: center; color: #8E8E93; cursor: pointer; margin-bottom: 16px;
            background: #fff; transition: 0.2s;
        }
        .upload-area.active { border-color: #007AFF; color: #007AFF; background: #F0F8FF; }

        /* Gacha Overlay */
        .gacha-overlay {
            position: fixed; inset: 0; z-index: 100;
            background: radial-gradient(circle at center, #2c3e50 0%, #000000 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: 0.3s;
        }
        .gacha-overlay.active { opacity: 1; visibility: visible; }
        
        .egg-wrapper { font-size: 120px; cursor: pointer; filter: drop-shadow(0 0 30px rgba(255,255,255,0.3)); transition: 0.3s; }
        .egg-wrapper:active { transform: scale(0.9); }
        .egg-shake { animation: shake 0.5s infinite; }
        
        .result-modal {
            background: white; width: 85%; max-width: 320px;
            border-radius: 20px; padding: 24px; text-align: center;
            transform: scale(0.8); opacity: 0; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: none; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .result-modal.show { transform: scale(1); opacity: 1; display: block; }

        @keyframes shake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            75% { transform: rotate(10deg); }
        }

        /* Feed Title with Glass Background */
        .feed-title {
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(5px);
            display: inline-block;
            padding: 4px 10px;
            border-radius: 8px;
        }

    </style>
</head>
<body>

    <header class="app-bar">
        <div class="app-title">Happy OWL Event ü¶â</div>
    </header>

    <div class="container mx-auto max-w-md px-4 content-area">
        
        <div class="mb-6 relative">
            <h2 class="text-sm font-bold text-gray-800 mb-2 uppercase tracking-wide ml-1 feed-title">
                ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            </h2>
            <div class="owl-carousel owl-theme" id="userCarousel"></div>
        </div>

        <div class="app-card">
            <h1 class="text-xl font-bold text-center mb-1 text-gray-800">‡∏™‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç</h1>
            <p class="text-center text-gray-500 text-xs mb-5">‡∏•‡∏∏‡πâ‡∏ô‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÅ‡∏Ñ‡πà‡∏£‡πà‡∏ß‡∏°‡∏™‡∏ô‡∏∏‡∏Å</p>
            
            <form id="userForm">
                <div>
                    <label class="input-label">‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
                    <input type="text" id="name" class="app-input" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠..." required>
                </div>
                
                <div>
                    <label class="input-label">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</label>
                    <textarea id="message" class="app-input" rows="3" placeholder="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." required></textarea>
                </div>

                <div>
                    <label class="input-label">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</label>
                    <div class="upload-area" onclick="document.getElementById('image').click()">
                        <ion-icon name="cloud-upload-outline" style="font-size: 24px;"></ion-icon>
                        <div class="text-xs mt-1" id="fileName">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</div>
                    </div>
                    <input type="file" id="image" accept="image/*" hidden onchange="updateFileName(this)">
                </div>

                <button type="submit" id="submitBtn" class="app-btn">
                    <ion-icon name="gift-outline"></ion-icon> ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏•‡∏∏‡πâ‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•
                </button>
            </form>
        </div>

    </div>

    <div class="gacha-overlay" id="gachaOverlay">
        <div class="text-white text-lg font-bold mb-8 animate-pulse" id="instructionText" style="text-shadow: 0 2px 4px rgba(0,0,0,0.5);">‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡πÑ‡∏Ç‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î!</div>
        
        <div class="egg-wrapper" id="eggWrapper">ü•ö</div>

        <div class="result-modal" id="resultModal">
            <div class="text-5xl mb-3">üéâ</div>
            <h3 class="text-xl font-bold text-gray-800 mb-1">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢!</h3>
            <div class="text-gray-500 text-sm mb-4">‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</div>
            
            <div class="bg-blue-50 rounded-xl p-4 mb-5 border border-blue-100">
                <div class="text-lg font-bold text-blue-600 mb-1 leading-tight" id="resultName">...</div>
                <div class="badge" id="resultBadge">...</div>
            </div>

            <button onclick="closeGacha()" class="app-btn bg-gray-900 text-white shadow-none">‡∏ï‡∏Å‡∏•‡∏á</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script>
        // --- 1. CONFIGURATION ---
        const supabaseUrl = 'https://kgyhqwgpeyfszowdrhbd.supabase.co';
        const supabaseKey = 'sb_publishable_DgFCEd6iMOogHTNtr4ht-Q_4SAn8FBN'; 

        // üé∞ LOGIC (‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Å‡∏•‡∏∑‡∏≠ 2.5%)
        const LIMIT_PER_MONTH = 5;
        const LIMITED_REWARDS = [
            { name: "‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á Sharing Room (3 ‡∏ä‡∏°.)", type: "limited", weight: 2.5 },
            { name: "‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á Mini Theatre (3 ‡∏ä‡∏°.)", type: "limited", weight: 2.5 },
            { name: "‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô AI (‡∏Ñ‡∏•‡∏∞‡πÅ‡∏ö‡∏ö)", type: "limited", weight: 2.5 },
            { name: "‡∏¢‡∏∑‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° 1 ‡πÄ‡∏ó‡πà‡∏≤", type: "limited", weight: 2.5 }
        ];
        const CONSOLATION_REWARD = { name: "‡∏•‡∏π‡∏Å‡∏≠‡∏° / ‡∏à‡∏π‡∏ö‡∏≤‡∏à‡∏∏‡πä‡∏ö üç≠", type: "consolation" };

        let mySupabase; 
        try {
            mySupabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        } catch (e) {
            console.error("Connection Error:", e);
        }

        let currentReward = null;

        $(document).ready(function(){
            if(!mySupabase) return;
            loadMessages();
            mySupabase.channel('realtime-messages')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'HappyOwl_messages' }, (payload) => {
                loadMessages(); 
            })
            .subscribe();
        });

        function updateFileName(input) {
            const fileNameDiv = document.getElementById('fileName');
            const uploadArea = document.querySelector('.upload-area');
            if (input.files && input.files[0]) {
                fileNameDiv.textContent = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: " + input.files[0].name;
                uploadArea.classList.add('active');
            } else {
                fileNameDiv.textContent = "‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)";
                uploadArea.classList.remove('active');
            }
        }

        async function loadMessages() {
            try {
                const { data, error } = await mySupabase
                    .from('HappyOwl_messages')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(10); 

                if (error) return;

                const carousel = $('#userCarousel');
                carousel.trigger('destroy.owl.carousel');
                carousel.empty();

                if(data) {
                    data.forEach(user => {
                        const imgSrc = user.image_url || 'https://via.placeholder.com/400x300?text=Happy+Owl';
                        let isLimited = LIMITED_REWARDS.some(r => r.name === user.reward);
                        let badgeHtml = isLimited 
                            ? `<span class="badge badge-limited"><ion-icon name="star"></ion-icon> Limited</span>`
                            : `<span class="badge badge-normal">Normal</span>`;

                        carousel.append(`
                            <div class="item">
                                <img src="${imgSrc}" class="user-img">
                                <div class="user-info">
                                    <div class="user-name">${escapeHtml(user.name)}</div>
                                    <div class="user-msg line-clamp-2">${escapeHtml(user.message)}</div>
                                    ${badgeHtml}
                                </div>
                            </div>
                        `);
                    });

                    carousel.owlCarousel({
                        margin: 15, 
                        loop: false,      
                        autoWidth: false, 
                        items: 1.2,       
                        nav: true,        
                        dots: false,      
                        autoplay: true,
                        autoplayTimeout: 5000,
                        smartSpeed: 500,
                        navText: ["<span>‚Äπ</span>","<span>‚Ä∫</span>"]
                    });
                }
            } catch (err) { console.error(err); }
        }

        async function checkStockAndGetReward() {
            let pool = [...LIMITED_REWARDS, { ...CONSOLATION_REWARD, weight: 90 }]; 
            let totalWeight = pool.reduce((sum, item) => sum + item.weight, 0);
            let randomNum = Math.random() * totalWeight;
            
            let selected = CONSOLATION_REWARD;
            for (let item of pool) {
                if (randomNum < item.weight) {
                    selected = item;
                    break;
                }
                randomNum -= item.weight;
            }

            if (selected.type === 'consolation') return selected;

            const date = new Date();
            const firstDay = new Date(date.getFullYear(), date.getMonth(), 1).toISOString();
            const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0).toISOString();

            const { count, error } = await mySupabase
                .from('HappyOwl_messages')
                .select('*', { count: 'exact', head: true }) 
                .eq('reward', selected.name)
                .gte('created_at', firstDay) 
                .lte('created_at', lastDay);

            if (error || count >= LIMIT_PER_MONTH) {
                return CONSOLATION_REWARD;
            }
            return selected;
        }

        document.getElementById('userForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            const name = document.getElementById('name').value;
            const message = document.getElementById('message').value;
            const imageFile = document.getElementById('image').files[0];

            if(!name || !message) return;

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<ion-icon name="sync-outline" class="animate-spin"></ion-icon> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';

            try {
                let publicUrl = null; 
                if (imageFile) {
                    let fileToUpload = imageFile;
                    if(imageFile.type.startsWith('image/')) {
                         fileToUpload = await compressImage(imageFile, 800, 0.6);
                    }
                    const fileName = Date.now() + '.jpg'; 
                    const { error: imgError } = await mySupabase.storage.from('HappyOwl_Image').upload(fileName, fileToUpload, { contentType: 'image/jpeg' });
                    if (!imgError) {
                        const { data: urlData } = mySupabase.storage.from('HappyOwl_Image').getPublicUrl(fileName);
                        publicUrl = urlData.publicUrl;
                    }
                }

                currentReward = await checkStockAndGetReward();

                const { error: dbError } = await mySupabase
                    .from('HappyOwl_messages')
                    .insert([{ 
                        name: name, 
                        message: message, 
                        image_url: publicUrl, 
                        reward: currentReward.name 
                    }]);

                if (dbError) throw dbError;

                document.getElementById('userForm').reset();
                updateFileName(document.getElementById('image'));
                openGacha();

            } catch (err) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<ion-icon name="gift-outline"></ion-icon> ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏•‡∏∏‡πâ‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•';
            }
        });

        function openGacha() {
            const overlay = document.getElementById('gachaOverlay');
            const egg = document.getElementById('eggWrapper');
            const text = document.getElementById('instructionText');
            
            overlay.classList.add('active');
            egg.style.display = 'block';
            text.style.display = 'block';
            
            egg.onclick = () => {
                egg.onclick = null;
                egg.classList.add('egg-shake');
                setTimeout(() => {
                    egg.style.display = 'none';
                    text.style.display = 'none';
                    showResult();
                }, 1000);
            };
        }

        function showResult() {
            const modal = document.getElementById('resultModal');
            const rName = document.getElementById('resultName');
            const rBadge = document.getElementById('resultBadge');

            rName.innerText = currentReward.name;
            if(currentReward.type === 'limited') {
                rBadge.className = 'badge badge-limited';
                rBadge.innerHTML = '<ion-icon name="star"></ion-icon> Limited Edition';
            } else {
                rBadge.className = 'badge badge-normal';
                rBadge.innerHTML = 'Consolation Prize';
            }
            
            modal.classList.add('show');
        }

        function closeGacha() {
            document.getElementById('gachaOverlay').classList.remove('active');
            document.getElementById('resultModal').classList.remove('show');
        }

        function compressImage(file, maxWidth, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width, height = img.height;
                        if (width > maxWidth) { height = Math.round((height * maxWidth) / width); width = maxWidth; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => resolve(blob), 'image/jpeg', quality);
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }
        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
